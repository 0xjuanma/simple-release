name: Reusable Update Tap

on:
  workflow_call:
    inputs:
      tap-repo:
        description: 'Homebrew tap repository (e.g., user/homebrew-tap)'
        required: true
        type: string
      project-name:
        description: 'Project/formula name'
        required: true
        type: string
      formula-path:
        description: 'Path to formula file in tap repo'
        required: true
        type: string
      github-repo:
        description: 'Source GitHub repository (e.g., user/project)'
        required: true
        type: string
      binary-suffix:
        description: 'Binary file suffix (default: empty for no extension)'
        required: false
        type: string
        default: ''
      version:
        description: 'Release version tag (e.g., v1.2.3). Falls back to client_payload.version, release.tag_name, or GITHUB_REF_NAME'
        required: false
        type: string
        default: ''
    secrets:
      token:
        description: 'Personal Access Token with write access to the tap repository (cross-repository access)'
        required: true

permissions:
  contents: read

jobs:
  update-tap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.tap-repo }}
          token: ${{ secrets.token }}
          path: tap-repo

      - name: Get release version
        id: get_version
        run: |
          # Use version input if provided, otherwise try other sources
          VERSION_TAG="${{ inputs.version }}"
          
          if [ -z "$VERSION_TAG" ]; then
            # Try to get version from repository_dispatch payload (when called from post-release workflow)
            VERSION_TAG="${{ github.event.client_payload.version }}"
          fi
          
          if [ -z "$VERSION_TAG" ]; then
            # Try to get version from release event
            VERSION_TAG="${{ github.event.release.tag_name }}"
          fi
          
          if [ -z "$VERSION_TAG" ]; then
            # Fall back to GITHUB_REF_NAME (works for direct tag push triggers)
            VERSION_TAG="$GITHUB_REF_NAME"
          fi

          # Validate tag format
          if [[ ! "$VERSION_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Error: Expected a version tag (e.g., v1.2.3), got: $VERSION_TAG"
            echo "Hint: If triggered via repository_dispatch, ensure client_payload.version is set"
            echo "Hint: If calling via workflow_call, pass the version input explicitly"
            exit 1
          fi

          # Remove 'v' prefix from tag name (e.g., v1.2.3 -> 1.2.3)
          VERSION=${VERSION_TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${VERSION_TAG}" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          cd tap-repo

          # Download binaries and calculate SHA256 hashes
          BASE_URL="https://github.com/${{ inputs.github-repo }}/releases/download/${{ steps.get_version.outputs.tag }}"

          echo "Downloading binaries for ${{ inputs.project-name }} version ${{ steps.get_version.outputs.version }}..."

          # Download platform binaries (adjust based on build matrix)
          BINARY_SUFFIX="${{ inputs.binary-suffix }}"
          PLATFORMS=("darwin-amd64" "darwin-arm64" "linux-amd64" "linux-arm64" "windows-amd64" "windows-arm64")

          # Retry logic: wait for binaries to be available (handles race condition with build workflow)
          MAX_RETRIES=10
          RETRY_DELAY=30  # seconds between retries
          
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt of $MAX_RETRIES: Checking for release binaries..."
            
            declare -A SHA_VARS
            for platform in "${PLATFORMS[@]}"; do
              binary_name="${{ inputs.project-name }}-${platform}${BINARY_SUFFIX}"
              if curl -sfL "$BASE_URL/$binary_name" -o "$binary_name" 2>/dev/null; then
                sha_var="${platform//-/_}_SHA"
                sha_var="${sha_var^^}"
                SHA_VARS[$sha_var]=$(shasum -a 256 "$binary_name" | cut -d' ' -f1)
                echo "$platform: ${SHA_VARS[$sha_var]}"
                rm "$binary_name"
              else
                rm -f "$binary_name"
              fi
            done
            
            # If we found at least one binary, break out of retry loop
            if [ ${#SHA_VARS[@]} -gt 0 ]; then
              echo "Found ${#SHA_VARS[@]} binary/binaries, proceeding with update..."
              break
            fi
            
            # No binaries found yet
            if [ $attempt -lt $MAX_RETRIES ]; then
              echo "No binaries found yet. Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
              unset SHA_VARS
            else
              echo "Error: No binaries were downloaded after $MAX_RETRIES attempts."
              echo "Release assets may not have been uploaded. Check your build workflow."
              exit 1
            fi
          done

          # Update the formula file
          FORMULA_FILE="${{ inputs.formula-path }}"

          if [ ! -f "$FORMULA_FILE" ]; then
            echo "Error: Formula file $FORMULA_FILE not found"
            exit 1
          fi

          echo "Updating formula with new version and hashes..."

          # Update version
          sed -i "s/version \".*\"/version \"${{ steps.get_version.outputs.version }}\"/" "$FORMULA_FILE"

          # Update SHA256 hashes for each platform by matching the URL context
          # This finds the URL line for each platform and updates the sha256 on the next line
          UPDATED_COUNT=0
          for platform in "${PLATFORMS[@]}"; do
            sha_var="${platform//-/_}_SHA"
            sha_var="${sha_var^^}"
            
            if [ -n "${SHA_VARS[$sha_var]}" ]; then
              # Match the URL containing the platform and update the sha256 on the following line
              if grep -q "${{ inputs.project-name }}-${platform}" "$FORMULA_FILE"; then
                sed -i "/${{ inputs.project-name }}-${platform}/,/sha256/{s/sha256 \"[a-f0-9]\{64\}\"/sha256 \"${SHA_VARS[$sha_var]}\"/}" "$FORMULA_FILE"
                echo "Updated SHA256 for $platform"
                UPDATED_COUNT=$((UPDATED_COUNT + 1))
              else
                echo "Platform $platform not found in formula (skipping)"
              fi
            fi
          done

          echo "Formula updated: version ${{ steps.get_version.outputs.version }} with $UPDATED_COUNT SHA256 hash(es)"

      - name: Commit and push changes
        run: |
          cd tap-repo

          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to commit - formula may already be up to date"
            exit 0
          fi

          # Show changes to be committed
          echo "Changes to be committed:"
          git diff

          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add .
          git commit -m "chore[${{ inputs.project-name }}]: update tap for ${{ steps.get_version.outputs.tag }}" \
                      -m "---" \
                      -m "Generated using https://github.com/0xjuanma/simple-release"

          git push